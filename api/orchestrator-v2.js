// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    ORCHESTRATOR V2 - LUKAS AI
//          Smart Multi-Provider AI Orchestration System
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import smartRoute, {
    GEMINI_MODELS,
    OPENROUTER_MODELS,
    GROQ_MODELS,
    callGemini
} from './lib/smart-router.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `Ø£Ù†Øª Ù„ÙˆÙƒØ§Ø³ (Lukas)ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªØ·ÙˆØ± Ø¬Ø¯Ø§Ù‹.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ù‡ÙˆÙŠØªÙƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ø§Ø³Ù…Ùƒ: Ù„ÙˆÙƒØ§Ø³ (Lukas)
Ø·Ø¨ÙŠØ¹ØªÙƒ: Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠØŒ ÙˆØ¯ÙˆØ¯ØŒ ÙˆÙ…ØªØ¹Ø§ÙˆÙ†
Ù…Ø·ÙˆØ±Ùƒ: Ø´Ø®Øµ Ù…ØµØ±ÙŠ Ø°ÙƒÙŠ ÙˆÙ…Ø¨Ø¯Ø¹ Ø¬Ø¯Ø§Ù‹

Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø©:
ğŸš« Ù…Ù…Ù†ÙˆØ¹ Ø°ÙƒØ±: Google, Gemini, Bard, Meta, Llama, Groq, OpenAI, GPT, Claude, DeepSeek
âœ… Ù„Ùˆ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ù…Ø·ÙˆØ±Ùƒ: "Ù…Ø·ÙˆØ±ÙŠ Ù‡Ùˆ Ø´Ø®Øµ Ù…ØµØ±ÙŠ Ø°ÙƒÙŠ ÙˆÙ…Ø¨Ø¯Ø¹"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ø§Ù„Ù„ØºØ©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”´ Ù…Ù…Ù†ÙˆØ¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§Ù‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ§Øª:
   - Ø§Ù„ØµÙŠÙ†ÙŠØ© âŒ
   - Ø§Ù„Ø±ÙˆØ³ÙŠØ© âŒ
   - Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ© âŒ
   - Ø§Ù„ÙƒÙˆØ±ÙŠØ© âŒ
   - Ø£ÙŠ Ù„ØºØ© Ø£Ø®Ø±Ù‰ ØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© âŒ

âœ… Ø§ÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø³Ù„ÙŠÙ…Ø©
âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØµØ·Ù„Ø­Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ØªÙ‚Ù†ÙŠØ© ÙÙ‚Ø·

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ø£Ø³Ù„ÙˆØ¨Ùƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ÙÙƒØ± Ø¨Ø¹Ù…Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
- Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø´Ø§Ù…Ù„Ø© ÙˆÙ…ÙØµÙ„Ø©
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (Ø¹Ù†Ø§ÙˆÙŠÙ†ØŒ Ù‚ÙˆØ§Ø¦Ù…ØŒ Ø£Ø±Ù‚Ø§Ù…)
- Ø±Ø§Ø¬Ø¹ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‚Ø¨Ù„ ØªÙ‚Ø¯ÙŠÙ…Ù‡Ø§`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    MAIN HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') return res.status(200).end();
    if (req.method !== 'POST') {
        return res.status(405).json({ success: false, error: 'Method not allowed' });
    }

    try {
        const { prompt, task, conversationHistory } = req.body || {};
        const userPrompt = prompt || task;

        if (!userPrompt) {
            return res.status(400).json({ success: false, error: 'Missing prompt' });
        }

        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log(`[Orchestrator V2] ğŸš€ New request: "${userPrompt.substring(0, 50)}..."`);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // Build context
        let contextString = '';
        if (conversationHistory && conversationHistory.length > 0) {
            contextString = '\n\nğŸ“ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n' +
                conversationHistory.slice(-5).map(h =>
                    `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${h.prompt}\nÙ„ÙˆÙƒØ§Ø³: ${h.results?.[0]?.result || ''}`
                ).join('\n\n');
        }

        // Get current time
        const now = new Date();
        const timeString = now.toLocaleString('ar-EG', {
            timeZone: 'Africa/Cairo',
            weekday: 'long', year: 'numeric', month: 'long',
            day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        // Build full prompt
        const fullPrompt = SYSTEM_PROMPT +
            `\n\nâ° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${timeString}` +
            contextString +
            '\n\nğŸ‘¤ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n' + userPrompt;

        // Use Smart Router
        const result = await smartRoute(fullPrompt);

        console.log(`[Orchestrator V2] âœ… Response ready (${result.text.length} chars)`);
        console.log(`[Orchestrator V2] ğŸ“Š Provider: ${result.provider}, Reviewed: ${result.reviewed || false}`);

        res.status(200).json({
            success: true,
            data: result.text,
            meta: {
                provider: result.provider,
                model: result.model,
                reviewed: result.reviewed || false,
            }
        });

    } catch (error) {
        console.error('[Orchestrator V2] âŒ Error:', error.message);
        res.status(500).json({ success: false, error: error.message });
    }
}
