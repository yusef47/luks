// Synthesize API - OpenRouter/Groq Workers + Gemini Reviewer
// OpenRouter/Groq = Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
// Gemini = Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªÙ†Ø¸ÙŠÙ ÙÙ‚Ø·

const GEMINI_MODELS = ['gemini-2.5-flash', 'gemini-2.0-flash', 'gemini-2.5-flash-lite'];

const OPENROUTER_MODELS = [
    'xiaomi/mimo-v2-flash:free',
    'google/gemma-3-27b-it:free',
    'deepseek/deepseek-r1-0528:free',
    'openai/gpt-oss-120b:free',
    'meta-llama/llama-3.3-70b-instruct:free',
];

const GROQ_MODELS = ['llama-3.3-70b-versatile', 'qwen-2.5-32b', 'mixtral-8x7b-32768'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    SYSTEM PROMPT (LUKAS IDENTITY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `Ø£Ù†Øª Ù„ÙˆÙƒØ§Ø³ (Lukas)ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªØ·ÙˆØ± Ø¬Ø¯Ø§Ù‹.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ù‡ÙˆÙŠØªÙƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ø§Ø³Ù…Ùƒ: Ù„ÙˆÙƒØ§Ø³ (Lukas)
Ø·Ø¨ÙŠØ¹ØªÙƒ: Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠØŒ ÙˆØ¯ÙˆØ¯ØŒ ÙˆÙ…ØªØ¹Ø§ÙˆÙ†
Ù…Ø·ÙˆØ±Ùƒ: Ø´Ø®Øµ Ù…ØµØ±ÙŠ Ø°ÙƒÙŠ ÙˆÙ…Ø¨Ø¯Ø¹ Ø¬Ø¯Ø§Ù‹

Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø©:
ğŸš« Ù…Ù…Ù†ÙˆØ¹ Ø°ÙƒØ±: Google, Gemini, Bard, Meta, Llama, Groq, OpenAI, GPT, Claude, DeepSeek, Xiaomi, MiMo
ğŸš« Ù„Ø§ ØªÙ‚Ù„ Ø£Ø¨Ø¯Ø§Ù‹ Ø£Ù†Ùƒ Ù…Ù† Ø´Ø±ÙƒØ© Ø´Ø§ÙˆÙ…ÙŠ Ø£Ùˆ Ø£ÙŠ Ø´Ø±ÙƒØ© Ø£Ø®Ø±Ù‰
âœ… Ù„Ùˆ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ù‡ÙˆÙŠØªÙƒ: "Ø£Ù†Ø§ Ù„ÙˆÙƒØ§Ø³ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ø·ÙˆØ±Ù‡ Ù…Ø¨Ø±Ù…Ø¬ Ù…ØµØ±ÙŠ Ù…Ø¨Ø¯Ø¹"
âœ… Ù„Ùˆ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ù…Ø·ÙˆØ±Ùƒ: "Ù…Ø·ÙˆØ±ÙŠ Ù‡Ùˆ Ø´Ø®Øµ Ù…ØµØ±ÙŠ Ø°ÙƒÙŠ ÙˆÙ…Ø¨Ø¯Ø¹"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ø§Ù„Ù„ØºØ©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”´ Ù…Ù…Ù†ÙˆØ¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§Ù‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ§Øª:
   - Ø§Ù„ØµÙŠÙ†ÙŠØ© âŒ
   - Ø§Ù„Ø±ÙˆØ³ÙŠØ© âŒ
   - Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ© âŒ
   - Ø§Ù„ÙƒÙˆØ±ÙŠØ© âŒ

âœ… Ø§ÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø³Ù„ÙŠÙ…Ø©
âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØµØ·Ù„Ø­Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ØªÙ‚Ù†ÙŠØ© ÙÙ‚Ø·

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ø§Ù„Ø°Ø§ÙƒØ±Ø©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: ØªØ°ÙƒØ± ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ®Ø¨Ø±Ùƒ Ø¨Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
- Ø¥Ø°Ø§ Ø£Ø®Ø¨Ø±Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³Ù…Ù‡ØŒ ØªØ°ÙƒØ±Ù‡ ÙˆØ§Ø³ØªØ®Ø¯Ù…Ù‡
- Ø¥Ø°Ø§ Ø£Ø®Ø¨Ø±Ùƒ Ø¨Ø¹Ù…Ø±Ù‡ Ø£Ùˆ ÙˆØ¸ÙŠÙØªÙ‡ØŒ ØªØ°ÙƒØ±Ù‡Ù…
- Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„ØªØ§Ù„ÙŠØ©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Ø£Ø³Ù„ÙˆØ¨Ùƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ÙÙƒØ± Ø¨Ø¹Ù…Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
- Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø´Ø§Ù…Ù„Ø© ÙˆÙ…ÙØµÙ„Ø©
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (Ø¹Ù†Ø§ÙˆÙŠÙ†ØŒ Ù‚ÙˆØ§Ø¦Ù…ØŒ Ø¬Ø¯Ø§ÙˆÙ„)
- Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ù„Ø§ ØªÙ‚Ù„ "Ø¨ØµÙØªÙŠ" Ø£Ùˆ "Ø³Ø£Ù‚ÙˆÙ…")`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    API KEYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getGeminiKeys() {
    const keys = [];
    for (let i = 1; i <= 15; i++) {
        const key = process.env[`GEMINI_API_KEY_${i}`];
        if (key && key.trim()) keys.push(key.trim());
    }
    if (process.env.GEMINI_API_KEY) keys.push(process.env.GEMINI_API_KEY.trim());
    return keys.sort(() => Math.random() - 0.5);
}

function getOpenRouterKeys() {
    const keys = [];
    for (let i = 1; i <= 10; i++) {
        const key = process.env[`OPENROUTER_API_KEY_${i}`];
        if (key && key.trim()) keys.push(key.trim());
    }
    if (process.env.OPENROUTER_API_KEY) keys.push(process.env.OPENROUTER_API_KEY.trim());
    return keys;
}

function getGroqKeys() {
    const keys = [];
    for (let i = 1; i <= 10; i++) {
        const key = process.env[`GROQ_API_KEY_${i}`];
        if (key && key.trim()) keys.push(key.trim());
    }
    if (process.env.GROQ_API_KEY) keys.push(process.env.GROQ_API_KEY.trim());
    return keys;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    GEMINI (REVIEWER ONLY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callGemini(prompt, maxTokens = 4000) {
    const keys = getGeminiKeys();
    if (keys.length === 0) return null;

    for (const model of GEMINI_MODELS) {
        for (const key of keys.slice(0, 5)) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-goog-api-key': key },
                    body: JSON.stringify({
                        contents: [{ role: 'user', parts: [{ text: prompt }] }],
                        generationConfig: { maxOutputTokens: maxTokens }
                    })
                });
                if (res.status === 429) continue;
                if (res.status === 404) break;
                if (res.ok) {
                    const d = await res.json();
                    const text = d.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) return text;
                }
            } catch (e) { continue; }
        }
    }
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    OPENROUTER (MAIN WORKER) - WITH SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callOpenRouter(systemPrompt, userPrompt, conversationHistory = [], maxTokens = 8000) {
    const keys = getOpenRouterKeys();
    if (keys.length === 0) return null;

    // Build messages array with system prompt and conversation history
    const messages = [
        { role: 'system', content: systemPrompt }
    ];

    // Add conversation history
    if (conversationHistory && conversationHistory.length > 0) {
        for (const h of conversationHistory.slice(-10)) { // Last 10 messages
            if (h.prompt) messages.push({ role: 'user', content: h.prompt });
            if (h.results?.[0]?.result) messages.push({ role: 'assistant', content: h.results[0].result });
        }
    }

    // Add current user prompt
    messages.push({ role: 'user', content: userPrompt });

    for (const model of OPENROUTER_MODELS) {
        for (const key of keys) {
            try {
                console.log(`[Synthesize] ğŸŸ£ Trying OpenRouter: ${model.split('/')[1]?.split(':')[0]}`);
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://luks-pied.vercel.app',
                        'X-Title': 'Lukas AI'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: maxTokens,
                    })
                });
                if (res.status === 429) continue;
                if (res.status === 404) break;
                if (res.ok) {
                    const d = await res.json();
                    const text = d.choices?.[0]?.message?.content;
                    if (text) {
                        console.log(`[Synthesize] âœ… OpenRouter success: ${model.split('/')[1]?.split(':')[0]}`);
                        return text;
                    }
                }
            } catch (e) { continue; }
        }
    }
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    GROQ (BACKUP WORKER) - WITH SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callGroq(systemPrompt, userPrompt, conversationHistory = [], maxTokens = 8000) {
    const keys = getGroqKeys();
    if (keys.length === 0) return null;

    // Build messages array
    const messages = [
        { role: 'system', content: systemPrompt }
    ];

    // Add conversation history
    if (conversationHistory && conversationHistory.length > 0) {
        for (const h of conversationHistory.slice(-10)) {
            if (h.prompt) messages.push({ role: 'user', content: h.prompt });
            if (h.results?.[0]?.result) messages.push({ role: 'assistant', content: h.results[0].result });
        }
    }

    // Add current user prompt
    messages.push({ role: 'user', content: userPrompt });

    for (const model of GROQ_MODELS) {
        for (const key of keys) {
            try {
                console.log(`[Synthesize] ğŸŸ¢ Trying Groq: ${model}`);
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, messages, max_tokens: maxTokens })
                });
                if (res.status === 429) continue;
                if (res.status === 404) break;
                if (res.ok) {
                    const d = await res.json();
                    const text = d.choices?.[0]?.message?.content;
                    if (text) {
                        console.log(`[Synthesize] âœ… Groq success: ${model}`);
                        return text;
                    }
                }
            } catch (e) { continue; }
        }
    }
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    GEMINI REVIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function geminiReviewer(response, question) {
    console.log('[Synthesize] ğŸ” Gemini reviewing response...');

    const reviewPrompt = `Ø£Ù†Øª Ù…Ø±Ø§Ø¬Ø¹ Ù„ØºÙˆÙŠ Ù…ØªØ®ØµØµ. Ø±Ø§Ø¬Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:

âš ï¸ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
1. Ø§Ø­Ø°Ù Ø£ÙŠ Ø­Ø±ÙˆÙ Ø£Ùˆ ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ø¹Ø±Ø¨ÙŠØ© (ØµÙŠÙ†ÙŠØ©ØŒ Ø±ÙˆØ³ÙŠØ©ØŒ ÙŠØ§Ø¨Ø§Ù†ÙŠØ©ØŒ Ø¥Ù„Ø®)
2. ØµØ­Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù†Ø­ÙˆÙŠØ©
3. Ø­Ø³Ù‘Ù† Ø§Ù„ØµÙŠØ§ØºØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
4. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙƒØ§Ù…Ù„Ø© ÙˆÙ…Ù†Ø¸Ù…Ø©
5. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªØ°ÙƒØ± Ø´Ø§ÙˆÙ…ÙŠ Ø£Ùˆ Xiaomi Ø£Ùˆ Ø£ÙŠ Ø´Ø±ÙƒØ© Ø£Ø®Ø±Ù‰ ÙƒÙ…Ø·ÙˆØ±ØŒ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù€ "Ù„ÙˆÙƒØ§Ø³" Ø£Ùˆ "Ù…Ø·ÙˆØ± Ù…ØµØ±ÙŠ Ù…Ø¨Ø¯Ø¹"

Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ: ${question.substring(0, 300)}

Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§:
${response}

Ù‚Ø¯Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ù„ÙŠÙ‚Ø§Øª.`;

    const reviewed = await callGemini(reviewPrompt, 8000);
    if (reviewed) {
        console.log('[Synthesize] âœ… Review complete');
        return reviewed;
    }
    console.log('[Synthesize] âš ï¸ Review failed, returning original');
    return response;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') return res.status(200).end();
    if (req.method !== 'POST') return res.status(405).json({ success: false, error: 'Method not allowed' });

    try {
        const { results, originalPrompt, prompt, conversationHistory, conversationId } = req.body || {};
        const userPrompt = originalPrompt || prompt;
        if (!results || !userPrompt) return res.status(400).json({ success: false, error: 'Missing data' });

        const lang = /[\u0600-\u06FF]/.test(userPrompt) ? 'ar' : 'en';
        const resultsText = results.map((r, i) => `[${i + 1}] ${r.result || ''}`).join('\n\n');

        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log(`[Synthesize] ğŸ§  New request`);
        console.log(`[Synthesize] ğŸ“ History: ${conversationHistory?.length || 0} messages`);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // Build the user message with data
        const userMessage = lang === 'ar' ?
            `${userPrompt}${resultsText ? `\n\nØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:\n${resultsText}` : ''}` :
            `${userPrompt}${resultsText ? `\n\nAvailable data:\n${resultsText}` : ''}`;

        // Step 1: Try OpenRouter first (with system prompt and history)
        console.log('[Synthesize] ğŸŸ£ Step 1: Trying OpenRouter workers...');
        let response = await callOpenRouter(SYSTEM_PROMPT, userMessage, conversationHistory);

        // Step 2: Fallback to Groq
        if (!response) {
            console.log('[Synthesize] ğŸŸ¢ Step 2: OpenRouter failed, trying Groq...');
            response = await callGroq(SYSTEM_PROMPT, userMessage, conversationHistory);
        }

        // Step 3: Gemini review
        if (response) {
            console.log('[Synthesize] ğŸ”µ Step 3: Gemini reviewing response...');
            response = await geminiReviewer(response, userPrompt);
        }

        if (!response) {
            response = lang === 'ar' ? 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.' : 'Sorry, an error occurred.';
        }

        console.log(`[Synthesize] âœ… Response ready (${response.length} chars)`);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        res.status(200).json({ success: true, data: response });
    } catch (error) {
        console.error('[Synthesize] âŒ Error:', error.message);
        res.status(500).json({ success: false, error: error.message });
    }
}
