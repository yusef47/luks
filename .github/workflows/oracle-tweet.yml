name: Oracle Tweet

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  tweet:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install playwright
      
      - name: Install Playwright browsers
        run: npx playwright install chromium
      
      - name: Get tweet from Oracle
        id: oracle
        run: |
          # Fetch from Oracle API
          RESPONSE=$(curl -s "https://luks-pied.vercel.app/api/oracle?action=cycle")
          
          # Save full response
          echo "$RESPONSE" > oracle_response.json
          
          # Extract action
          ACTION=$(echo "$RESPONSE" | jq -r '.action // "NONE"')
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          
          # Extract tweet and save to file (to handle special characters)
          echo "$RESPONSE" | jq -r '.tweet // ""' > tweet.txt
          
          # Check if we should post
          TWEET_LENGTH=$(cat tweet.txt | wc -c)
          if [ "$ACTION" = "SLEEP" ] || [ "$TWEET_LENGTH" -lt 10 ]; then
            echo "should_post=false" >> $GITHUB_OUTPUT
            echo "No tweet to post (action: $ACTION)"
          else
            echo "should_post=true" >> $GITHUB_OUTPUT
            echo "Tweet ready to post:"
            cat tweet.txt
          fi
      
      - name: Post to Twitter
        if: steps.oracle.outputs.should_post == 'true'
        env:
          TWITTER_COOKIES: ${{ secrets.TWITTER_COOKIES }}
        run: node scripts/post-tweet.js
